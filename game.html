<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QuizFlow 3.2 - Game</title>
    <link rel="stylesheet" href="css/game.css">
    <!-- å‹•æ…‹è¼‰å…¥ç‰¹æ®Šä¸»é¡Œ CSSï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰-->
    <link rel="stylesheet" id="customThemeCSS">
</head>
<body>

    <!-- ğŸ†• è¿”å›ä¸»é¸å–®æŒ‰éˆ• -->
    <button class="menu-btn" onclick="returnToMenu()">â† è¿”å›ä¸»é¸å–®</button>

    <div id="preload-container" style="display:none;"></div>

    <div id="time-bar-top" class="time-bar-container hidden" style="top:0;">
        <div id="time-fill-top" class="time-fill"></div>
    </div>

    <div id="time-bar-bot" class="time-bar-container hidden" style="bottom:0;">
        <div id="time-fill-bot" class="time-fill"></div>
    </div>

    <div id="warning-layer" class="overlay-transparent hidden">
        <div class="warn-text warn-p1">æœ€å¾Œ 5 ç§’!</div> <div class="warn-text warn-p2">æœ€å¾Œ 5 ç§’!</div> </div>

    <div id="main-menu" class="overlay">
        <div class="menu-title">é§æ³¢åç¨±å¤§å¸«</div>
        <div class="rule-text">
            <b>V2.3 æ›´æ–°</b>ï¼šé›™å‘æ™‚é–“æ¢ã€æœ€å¾Œå€’æ•¸éŸ³æ•ˆ<br>
            æ¶ç­”è¦å‰‡ï¼šå…ˆç­”å°+2ï¼Œå¾Œç­”å°+1<br>
            <b>é€£çºŒç­”éŒ¯</b>å°‡è§¸ç™¼ã€Œç ´éŸ³ã€æ‡²ç½° (-2åˆ†)<br>
            Design: chaher@dysh.tyc.edu.tw, AI coding
        </div>
        <button class="mode-btn btn-table" onclick="Game.toggleTable(true)" style="margin-bottom: 20px;">ğŸ“– é§æ³¢åç¨±æ•™å­¸</button>
        
        <div style="width:100%; border-bottom: 2px solid #eee; margin-bottom:15px; padding-bottom:5px; font-weight:bold; color:#333;">Part 1: çœ‹åœ–é¸å­—</div>
        <div class="mode-section">
            <div class="mode-label">ğŸ”µ å…©ç«¯å›ºå®š</div>
            <button class="mode-btn btn-practice" onclick="Game.init('practice', 0, 'level1')">è‡ªå·±ç·´ç¿’</button>
            <button class="mode-btn btn-versus" onclick="Game.init('versus', 20, 'level1')">é›™äººæ¶ç­”</button>
        </div>
        <div class="mode-section">
            <div class="mode-label">ğŸ”µ ä¸€ç«¯å›ºå®šä¸€ç«¯è‡ªç”±</div>
            <button class="mode-btn btn-practice" onclick="Game.init('practice', 0, 'level2')">è‡ªå·±ç·´ç¿’</button>
            <button class="mode-btn btn-versus" onclick="Game.init('versus', 20, 'level2')">é›™äººæ¶ç­”</button>
        </div>
        <div class="mode-section">
            <div class="mode-label">ğŸ”µ æ··åˆé¡Œç›®</div>
            <button class="mode-btn btn-practice" onclick="Game.init('practice', 0, 'level3')">è‡ªå·±ç·´ç¿’</button>
            <button class="mode-btn btn-speed" onclick="Game.init('speed', 0, 'level3')">é›™äººç«¶é€Ÿ</button>
            <button class="mode-btn btn-versus" onclick="Game.init('versus', 20, 'level3')">é›™äººæ¶ç­”</button>
        </div>

        <div style="width:100%; border-bottom: 2px solid #eee; margin:20px 0 15px 0; padding-bottom:5px; font-weight:bold; color:#333;">Part 2: çœ‹å­—é¸åœ–</div>
        <div class="mode-section">
            <div class="mode-label" style="border-left-color: #27ae60;">ğŸŸ¢ å…©ç«¯å›ºå®š</div>
            <button class="mode-btn btn-practice" onclick="Game.init('practice', 0, 'level4')">è‡ªå·±ç·´ç¿’</button>
            <button class="mode-btn btn-versus" onclick="Game.init('versus', 20, 'level4')">é›™äººæ¶ç­”</button>
        </div>
        <div class="mode-section">
            <div class="mode-label" style="border-left-color: #27ae60;">ğŸŸ¢ ä¸€ç«¯å›ºå®šä¸€ç«¯è‡ªç”±</div>
            <button class="mode-btn btn-practice" onclick="Game.init('practice', 0, 'level5')">è‡ªå·±ç·´ç¿’</button>
            <button class="mode-btn btn-versus" onclick="Game.init('versus', 20, 'level5')">é›™äººæ¶ç­”</button>
        </div>
        <div class="mode-section">
            <div class="mode-label" style="border-left-color: #27ae60;">ğŸŸ¢ æ··åˆé¡Œç›®</div>
            <button class="mode-btn btn-practice" onclick="Game.init('practice', 0, 'level6')">è‡ªå·±ç·´ç¿’</button>
            <button class="mode-btn btn-speed" onclick="Game.init('speed', 0, 'level6')">é›™äººç«¶é€Ÿ</button>
            <button class="mode-btn btn-versus" onclick="Game.init('versus', 20, 'level6')">é›™äººæ¶ç­”</button>
        </div>
        <div style="height: 50px;"></div> 
    </div>

    <div id="ref-table-overlay" class="overlay hidden">
        <button class="close-btn" onclick="Game.toggleTable(false)">âœ– é—œé–‰</button>
        <h2 style="margin-bottom:10px;">é§æ³¢åè©å°ç…§è¡¨</h2>
        <div id="table-container" style="overflow-y: auto; max-height: 80vh; width:95%; max-width:600px;">
            <table class="math-table" id="math-table-body"></table>
        </div>
    </div>

    <div id="countdown-overlay" class="overlay hidden">
        <div class="countdown-wrapper-top"><div id="cd-num-top" class="countdown-number">3</div></div>
        <div style="height: 50px;"></div>
        <div class="countdown-wrapper-bot"><div id="cd-num-bot" class="countdown-number">3</div></div>
    </div>

    <div id="game-over" class="overlay hidden">
        <div class="go-half go-top">
            <div class="result-title" id="res-title-p1"></div>
            <div class="result-sub" id="res-score-p1"></div>
            <div class="result-msg" id="res-msg-p1"></div>
        </div>
        <div style="z-index:50; padding: 10px;">
            <button class="menu-btn-small" onclick="Game.showMenu()">ä¸»é¸å–®</button>
        </div>
        <div class="go-half go-bottom">
            <div class="result-title" id="res-title-p2"></div>
            <div class="result-sub" id="res-score-p2"></div>
            <div class="result-msg" id="res-msg-p2"></div>
        </div>
    </div>

    <div id="single-player-area" class="hidden">
        <div class="sp-header">
            <div class="sp-score-box">Score: <span id="sp-score">0</span></div>
            <div class="sp-controls">
                <button class="menu-btn-small" onclick="Game.toggleTable(true)">é§æ³¢åç¨±æ•™å­¸</button>
                <button class="menu-btn-small" style="margin-left:5px;" onclick="Game.showMenu()">MENU</button>
            </div>
        </div>
        <div class="combo-container hidden" id="sp-combo-box">COMBO x<span id="sp-combo-val">0</span></div>
        <div class="question-box" id="q-sp"></div>
        <div class="options-grid sp-options-grid" id="opts-sp"></div>
        <div id="feedback-sp" class="overlay hidden" style="background:rgba(255,255,255,0.9);">
            <div class="big-circle"></div>
        </div>
    </div>

    <div id="versus-container">
        <div id="p1-area" class="player-area">
            <div class="combo-display" id="combo-p1" style="opacity:0">Combo x0</div>
            <div class="question-box" id="q-p1"></div>
            <div class="options-grid" id="opts-p1"></div>
            <div id="feedback-p1" class="overlay hidden" style="background:rgba(255,255,255,0.9);">
                <div class="big-circle"></div>
                <div class="waiting-text" id="wait-text-p1">å‹•ä½œçœŸå¿«!ç­‰å¾…å°æ‰‹...</div>
            </div>
        </div>

        <div class="divider">
            <div class="score-info-group">
                <div class="score-label" style="color:var(--p2-color)">P2</div>
                <div class="score-num" id="score-p2">0</div>
            </div>
            <div class="bar-container">
                <div class="bar-fill" id="bar-p2" style="background:var(--p2-color); width:0%;"></div>
            </div>
            <div class="center-control">
                <button class="menu-btn-small" onclick="Game.showMenu()">MENU</button>
                <div id="timer-display-center" class="timer-center hidden">30</div>
            </div>
            <div class="bar-container bar-reverse">
                <div class="bar-fill" id="bar-p1" style="background:var(--p1-color); width:0%;"></div>
            </div>
            <div class="score-info-group p1-group">
                <div class="score-label" style="color:var(--p1-color)">P1</div>
                <div class="score-num" id="score-p1">0</div>
            </div>
        </div>

        <div id="p2-area" class="player-area">
            <div class="combo-display" id="combo-p2" style="opacity:0">Combo x0</div>
            <div class="question-box" id="q-p2"></div>
            <div class="options-grid" id="opts-p2"></div>
            <div id="feedback-p2" class="overlay hidden" style="background:rgba(255,255,255,0.9);">
                <div class="big-circle"></div>
                <div class="waiting-text" id="wait-text-p2">å‹•ä½œçœŸå¿«!ç­‰å¾…å°æ‰‹...</div>
            </div>
        </div>
    </div>

    <!-- ==================== ä¸»é¡Œè¼‰å…¥ç³»çµ± ==================== -->
    <script src="core/theme-loader.js"></script>
    <script>
        // è®€å– URL åƒæ•¸
        const urlParams = new URLSearchParams(window.location.search);
        const themeName = urlParams.get('theme');

        // é©—è­‰ä¸»é¡Œåƒæ•¸
        if (!themeName) {
            alert('âŒ è«‹å¾ä¸»é¸å–®é¸æ“‡ä¸»é¡Œ');
            window.location.href = 'index.html';
            throw new Error('No theme specified');
        }

        console.log(`ğŸ® æº–å‚™è¼‰å…¥ä¸»é¡Œ: ${themeName}`);

        // ä¸»é¡Œè³‡æ–™ï¼ˆå…¨åŸŸè®Šæ•¸ï¼‰
        let themeData = null;
        const loader = new ThemeLoader();

        /**
         * è¼‰å…¥ä¸»é¡Œè³‡æ–™
         */
        async function initTheme() {
            try {
                console.log(`ğŸ“¥ è¼‰å…¥ä¸»é¡Œ ${themeName}...`);
                themeData = await loader.loadTheme(themeName);
                console.log('âœ… ä¸»é¡Œè¼‰å…¥æˆåŠŸ:', themeData);

                // ğŸ¨ å¦‚æœæœ‰ç‰¹æ®Š CSSï¼Œå‹•æ…‹è¼‰å…¥
                if (themeData.theme.gameDisplay?.useCustomCSS) {
                    const customCSS = document.getElementById('customThemeCSS');
                    const cssPath = themeData.theme.gameDisplay.customCSSPath;
                    customCSS.href = `themes/${themeName}/${cssPath}`;
                    console.log(`ğŸ¨ è¼‰å…¥ç‰¹æ®Š CSS: ${cssPath}`);
                }

                // ğŸ¨ å¥—ç”¨ä¸»é¡Œè‰²ï¼ˆé€šé CSS è®Šæ•¸ï¼‰
                applyThemeColors(themeData.theme.gameDisplay);

                console.log('âœ… ä¸»é¡Œç³»çµ±åˆå§‹åŒ–å®Œæˆ');
                
            } catch (error) {
                console.error('âŒ ä¸»é¡Œè¼‰å…¥å¤±æ•—:', error);
                alert(`ä¸»é¡Œè¼‰å…¥å¤±æ•—ï¼š${error.message}\n\nå°‡è¿”å›ä¸»é¸å–®`);
                window.location.href = 'index.html';
            }
        }

        /**
         * å¥—ç”¨ä¸»é¡Œè‰²åˆ° CSS è®Šæ•¸
         */
        function applyThemeColors(gameDisplay) {
            if (!gameDisplay || !gameDisplay.colors) return;

            const root = document.documentElement;
            const colors = gameDisplay.colors;

            if (colors.player1) {
                root.style.setProperty('--p1-color', colors.player1);
                root.style.setProperty('--color-p1', colors.player1);
            }
            if (colors.player2) {
                root.style.setProperty('--p2-color', colors.player2);
                root.style.setProperty('--color-p2', colors.player2);
            }
            if (colors.background) {
                root.style.setProperty('--bg-color', colors.background);
                root.style.setProperty('--color-bg', colors.background);
            }

            console.log('ğŸ¨ ä¸»é¡Œè‰²å·²å¥—ç”¨');
        }

        /**
         * è¿”å›ä¸»é¸å–®
         */
        function returnToMenu() {
            if (confirm('ç¢ºå®šè¦è¿”å›ä¸»é¸å–®å—ï¼Ÿé€²åº¦å°‡ä¸æœƒä¿å­˜ã€‚')) {
                window.location.href = 'index.html';
            }
        }

        // åˆå§‹åŒ–ä¸»é¡Œï¼ˆç«‹å³åŸ·è¡Œï¼‰
        initTheme();
    </script>

    <!-- ==================== éŠæˆ²å¼•æ“ï¼ˆåŸæœ¬çš„ä»£ç¢¼ï¼‰==================== -->
    <script src="core/game-engine.js"></script>

</body>
</html>
