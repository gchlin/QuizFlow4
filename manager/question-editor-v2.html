<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¡Œç›®ç·¨è¼¯å™¨ v2.0</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2rem;
        }

        .subtitle {
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* é ‚éƒ¨å·¥å…·åˆ— */
        .top-toolbar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            align-items: center;
        }

        .toolbar-section {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .toolbar-separator {
            width: 2px;
            height: 30px;
            background: #dee2e6;
            margin: 0 5px;
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #2ecc71; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-info { background: #17a2b8; color: white; }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-sm {
            padding: 5px 12px;
            font-size: 0.85rem;
        }

        input[type="file"] { display: none; }

        /* çµ±è¨ˆå¡ç‰‡ */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            padding: 15px;
            background: white;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-top: 4px solid;
        }

        .stat-card.pools { border-color: #9b59b6; }
        .stat-card.sets { border-color: #3498db; }
        .stat-card.questions { border-color: #2ecc71; }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-card.pools .stat-number { color: #9b59b6; }
        .stat-card.sets .stat-number { color: #3498db; }
        .stat-card.questions .stat-number { color: #2ecc71; }

        .stat-label {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        /* å€å¡Šæ¨£å¼ */
        .section {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #dee2e6;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #2c3e50;
        }

        /* å¯å±•é–‹é …ç›® */
        .collapsible-item {
            background: white;
            margin: 10px 0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .collapsible-item.pool { border-left: 4px solid #9b59b6; }
        .collapsible-item.set { border-left: 4px solid #3498db; }

        .item-header {
            padding: 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            transition: background 0.3s;
        }

        .item-header:hover {
            background: #f8f9fa;
        }

        .item-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .expand-icon {
            font-size: 1.2rem;
            transition: transform 0.3s;
            width: 20px;
            text-align: center;
        }

        .collapsible-item.expanded .expand-icon {
            transform: rotate(90deg);
        }

        .item-title {
            font-weight: bold;
            color: #2c3e50;
        }

        .item-meta {
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-left: 10px;
        }

        .item-status {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: bold;
        }

        .status-ok {
            background: #d4edda;
            color: #155724;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        .item-actions {
            display: flex;
            gap: 5px;
        }

        .item-content {
            padding: 15px;
            border-top: 1px solid #dee2e6;
            display: none;
            background: #fafbfc;
        }

        .collapsible-item.expanded .item-content {
            display: block;
        }

        /* è¡¨æ ¼æ¨£å¼ */
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 5px;
            overflow: hidden;
        }

        th {
            background: #34495e;
            color: white;
            padding: 12px 10px;
            text-align: left;
            font-weight: bold;
        }

        td {
            padding: 10px;
            border-bottom: 1px solid #ecf0f1;
            vertical-align: middle;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .preview-img {
            max-width: 80px;
            max-height: 60px;
            border-radius: 4px;
            border: 2px solid #dee2e6;
        }

        .path-error {
            color: #e74c3c;
            font-size: 0.85rem;
        }

        /* Modal æ¨£å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #2c3e50;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-close {
            cursor: pointer;
            font-size: 1.5rem;
            color: #7f8c8d;
        }

        .modal-close:hover {
            color: #e74c3c;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #dee2e6;
        }

        /* è¡¨å–®æ¨£å¼ */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .form-label .required {
            color: #e74c3c;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 1rem;
            font-family: inherit;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 5px;
        }

        .checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* Alert æ¨£å¼ */
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 5px solid;
        }

        .alert-success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .alert-danger {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        .alert-warning {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }

        .alert-info {
            background: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 1.1rem;
        }

        .hidden {
            display: none !important;
        }

        /* Prompt ç”Ÿæˆå™¨ç‰¹æ®Šæ¨£å¼ */
        .prompt-output {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .copy-success {
            background: #2ecc71;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.85rem;
            margin-left: 10px;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Badge æ¨£å¼ */
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: bold;
            margin: 2px;
        }

        .badge-category {
            background: #d1ecf1;
            color: #0c5460;
        }

        .badge-pool {
            background: #e8daef;
            color: #6c3483;
        }

        /* åœ–ç‰‡ä¸Šå‚³å€ */
        .image-upload-zone {
            border: 2px dashed #bdc3c7;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            background: #f8f9fa;
            margin: 15px 0;
        }

        .image-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .image-preview-item {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
            background: white;
        }

        .image-preview-item img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .image-preview-item input {
            width: 100%;
            padding: 5px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            h1 {
                font-size: 1.5rem;
            }

            .top-toolbar {
                flex-direction: column;
            }

            table {
                font-size: 0.85rem;
            }

            th, td {
                padding: 8px 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“ é¡Œç›®ç·¨è¼¯å™¨ v2.0</h1>
        <p class="subtitle">åœ–å½¢åŒ–ä»‹é¢ï¼Œè¼•é¬†ç®¡ç†é¡Œåº«</p>

        <!-- é ‚éƒ¨å·¥å…·åˆ— -->
        <div class="top-toolbar">
            <div class="toolbar-section">
                <button class="btn btn-info" onclick="openPromptGenerator()">
                    ğŸ¤– AI Prompt ç”Ÿæˆå™¨
                </button>
                <button class="btn btn-info" onclick="downloadSampleJSON()">
                    ğŸ“¥ ä¸‹è¼‰ç¯„ä¾‹ JSON
                </button>
            </div>

            <div class="toolbar-separator"></div>

            <div class="toolbar-section">
                <button class="btn btn-primary" onclick="document.getElementById('loadFile').click()">
                    ğŸ“‚ è¼‰å…¥ JSON
                </button>
                <input type="file" id="loadFile" accept=".json">
                
                <button class="btn btn-warning" onclick="openBatchImageUpload()">
                    ğŸ–¼ï¸ æ‰¹é‡åŒ¯å…¥åœ–ç‰‡
                </button>
            </div>

            <div class="toolbar-separator"></div>

            <div class="toolbar-section">
                <button class="btn btn-success" onclick="openNewPool()">
                    â• æ–°å¢é¸é …æ± 
                </button>
                
                <button class="btn btn-success" onclick="openNewSet()">
                    â• æ–°å¢é¡Œç›®é›†
                </button>
                
                <button class="btn btn-warning" onclick="openMergeAI()">
                    ğŸ¤– åˆä½µ AI é¡Œç›®
                </button>
            </div>

            <div class="toolbar-separator"></div>

            <div class="toolbar-section">
                <button class="btn btn-primary" onclick="exportJSON()">
                    ğŸ’¾ åŒ¯å‡º JSON
                </button>
                
                <button class="btn btn-danger" onclick="clearAll()">
                    ğŸ—‘ï¸ æ¸…ç©ºå…¨éƒ¨
                </button>
            </div>
        </div>

        <!-- çµ±è¨ˆå¡ç‰‡ -->
        <div class="stats hidden" id="stats">
            <div class="stat-card pools">
                <div class="stat-number" id="statPools">0</div>
                <div class="stat-label">é¸é …æ± </div>
            </div>
            <div class="stat-card sets">
                <div class="stat-number" id="statSets">0</div>
                <div class="stat-label">é¡Œç›®é›†</div>
            </div>
            <div class="stat-card questions">
                <div class="stat-number" id="statQuestions">0</div>
                <div class="stat-label">ç¸½é¡Œç›®æ•¸</div>
            </div>
        </div>

        <!-- é¸é …æ± å€å¡Š -->
        <div class="section">
            <div class="section-header">
                <div class="section-title">ğŸ“¦ é¸é …æ± </div>
                <button class="btn btn-sm btn-success" onclick="openNewPool()">â• æ–°å¢</button>
            </div>
            <div id="poolsList" class="empty-state">
                å°šç„¡é¸é …æ± ï¼Œé»æ“Šã€Œæ–°å¢é¸é …æ± ã€é–‹å§‹
            </div>
        </div>

        <!-- é¡Œç›®é›†å€å¡Š -->
        <div class="section">
            <div class="section-header">
                <div class="section-title">ğŸ“š é¡Œç›®é›†</div>
                <button class="btn btn-sm btn-success" onclick="openNewSet()">â• æ–°å¢</button>
            </div>
            <div id="setsList" class="empty-state">
                å°šç„¡é¡Œç›®é›†ï¼Œé»æ“Šã€Œæ–°å¢é¡Œç›®é›†ã€é–‹å§‹
            </div>
        </div>
    </div>

    <!-- AI Prompt ç”Ÿæˆå™¨ Modal -->
    <div class="modal" id="promptModal">
        <div class="modal-content">
            <div class="modal-header">
                ğŸ¤– AI Prompt ç”Ÿæˆå™¨
                <span class="modal-close" onclick="closeModal('promptModal')">Ã—</span>
            </div>

            <div class="alert alert-info">
                <strong>ğŸ’¡ ä½¿ç”¨èªªæ˜</strong><br>
                å¡«å¯«ä»¥ä¸‹è³‡è¨Šï¼Œç³»çµ±æœƒè‡ªå‹•ç”ŸæˆåŒ…å«ç¯„ä¾‹ JSON çš„ Promptï¼Œè®“ AI ç”¢ç”Ÿç¬¦åˆæ ¼å¼çš„é¡Œåº«ã€‚
            </div>

            <div class="form-group">
                <label class="form-label">æƒ…å¢ƒé¸æ“‡ <span class="required">*</span></label>
                <select id="promptScenario" class="form-select" onchange="updatePromptForm()">
                    <option value="new">å‰µå»ºå…¨æ–°ä¸»é¡Œ</option>
                    <option value="expand-questions">æ“´å……é¡Œç›®ï¼ˆé¡Œç›®å¤ªå°‘ï¼‰</option>
                    <option value="expand-pools">æ“´å……é¸é …ï¼ˆé¸é …å¤ªå°‘ï¼‰</option>
                </select>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">ä¸»é¡Œåç¨± <span class="required">*</span></label>
                    <input type="text" id="promptTheme" class="form-input" placeholder="ä¾‹å¦‚ï¼šåŒ–å­¸å…ƒç´ é€±æœŸè¡¨">
                </div>
                <div class="form-group">
                    <label class="form-label">é›£åº¦ç­‰ç´š</label>
                    <select id="promptDifficulty" class="form-select">
                        <option value="easy">ç°¡å–®</option>
                        <option value="medium" selected>ä¸­ç­‰</option>
                        <option value="hard">å›°é›£</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">é¡Œç›®æ•¸é‡</label>
                    <input type="number" id="promptQuestionCount" class="form-input" value="20" min="1">
                </div>
                <div class="form-group">
                    <label class="form-label">æ¯å€‹é¸é …æ± çš„é¸é …æ•¸</label>
                    <input type="number" id="promptOptionCount" class="form-input" value="8" min="4">
                </div>
            </div>

            <!-- æ“´å……æ¨¡å¼é¡å¤–æ¬„ä½ -->
            <div id="expandFields" class="hidden">
                <div class="form-group">
                    <label class="form-label">ç¾æœ‰é¡Œç›®é›† ID</label>
                    <input type="text" id="promptExistingSetId" class="form-input" placeholder="ä¾‹å¦‚ï¼šlevel1">
                </div>
                <div class="form-group">
                    <label class="form-label">ç¾æœ‰é¸é …æ±  ID</label>
                    <input type="text" id="promptExistingPoolId" class="form-input" placeholder="ä¾‹å¦‚ï¼šelements">
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-primary" onclick="generatePrompt()">
                    ğŸ¯ ç”Ÿæˆ Prompt
                </button>
                <button class="btn" onclick="closeModal('promptModal')">å–æ¶ˆ</button>
            </div>

            <!-- Prompt è¼¸å‡ºå€ -->
            <div id="promptOutputArea" class="hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
                    <strong>ç”Ÿæˆçš„ Promptï¼š</strong>
                    <button class="btn btn-sm btn-success" onclick="copyPrompt()">
                        ğŸ“‹ è¤‡è£½ Prompt
                    </button>
                </div>
                <div class="prompt-output" id="promptOutput"></div>
                
                <div class="alert alert-info" style="margin-top: 15px;">
                    <strong>ğŸ“Œ ä¸‹ä¸€æ­¥ï¼š</strong><br>
                    1. è¤‡è£½ä¸Šæ–¹ Prompt<br>
                    2. è²¼çµ¦ AIï¼ˆChatGPT/Claudeï¼‰<br>
                    3. è¤‡è£½ AI ç”Ÿæˆçš„ JSON<br>
                    4. é»æ“Šé ‚éƒ¨å·¥å…·åˆ—çš„ã€ŒğŸ¤– åˆä½µ AI é¡Œç›®ã€æŒ‰éˆ•<br>
                    5. è²¼ä¸Š JSON ä¸¦åˆä½µ
                </div>
            </div>
        </div>
    </div>

    <!-- æ‰¹é‡åŒ¯å…¥åœ–ç‰‡ Modal -->
    <div class="modal" id="imageUploadModal">
        <div class="modal-content">
            <div class="modal-header">
                ğŸ–¼ï¸ æ‰¹é‡åŒ¯å…¥åœ–ç‰‡
                <span class="modal-close" onclick="closeModal('imageUploadModal')">Ã—</span>
            </div>

            <div class="alert alert-info">
                <strong>ğŸ’¡ ä½¿ç”¨èªªæ˜</strong><br>
                é¸æ“‡å¤šå¼µåœ–ç‰‡ï¼Œç³»çµ±æœƒè‡ªå‹•ä½¿ç”¨æª”åï¼ˆå»æ‰å‰¯æª”åï¼‰ä½œç‚º IDï¼Œä½ ä¹Ÿå¯ä»¥å€‹åˆ¥ä¿®æ”¹ã€‚
            </div>

            <div class="form-group">
                <label class="form-label">ID å‘½åæ–¹å¼</label>
                <select id="imageIdMethod" class="form-select" onchange="updateImageIds()">
                    <option value="filename">ä½¿ç”¨æª”åï¼ˆå»å‰¯æª”åï¼‰</option>
                    <option value="sequential">ä½¿ç”¨æµæ°´è™Ÿ (IMG_001, IMG_002...)</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">é¸æ“‡åœ–ç‰‡</label>
                <input type="file" id="batchImageInput" accept="image/*" multiple onchange="previewImages()" style="display: block;">
            </div>

            <div id="imagePreviewArea" class="hidden">
                <h4 style="margin: 15px 0;">é è¦½èˆ‡ ID è¨­å®šï¼š</h4>
                <div class="image-preview-grid" id="imagePreviewGrid"></div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-success" onclick="importAsPool()" id="importPoolBtn" disabled>
                    â• åŒ¯å…¥ç‚ºé¸é …æ± 
                </button>
                <button class="btn btn-primary" onclick="importAsQuestions()" id="importQuestionsBtn" disabled>
                    â• åŒ¯å…¥ç‚ºé¡Œç›®
                </button>
                <button class="btn" onclick="closeModal('imageUploadModal')">é—œé–‰</button>
            </div>
        </div>
    </div>

    <!-- é¸é …æ± ç·¨è¼¯ Modal -->
    <div class="modal" id="poolModal">
        <div class="modal-content">
            <div class="modal-header">
                <span id="poolModalTitle">ç·¨è¼¯é¸é …æ± </span>
                <span class="modal-close" onclick="closeModal('poolModal')">Ã—</span>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">æ±  ID <span class="required">*</span></label>
                    <input type="text" id="poolId" class="form-input" placeholder="ä¾‹å¦‚: scientists">
                </div>
                <div class="form-group">
                    <label class="form-label">åç¨±</label>
                    <input type="text" id="poolName" class="form-input" placeholder="ä¾‹å¦‚: ç§‘å­¸å®¶">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">é¡å‹ <span class="required">*</span></label>
                    <select id="poolType" class="form-select">
                        <option value="text">text (æ–‡å­—)</option>
                        <option value="image">image (åœ–ç‰‡)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">é¡åˆ¥ï¼ˆé¸ç”¨ï¼‰</label>
                    <input type="text" id="poolCategory" class="form-input" placeholder="ä¾‹å¦‚: äººåã€æ•¸å€¼">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">é¸é …åˆ—è¡¨</label>
                <table id="poolItemsTable">
                    <thead>
                        <tr>
                            <th style="width: 20%;">é¸é … ID</th>
                            <th style="width: 50%;">å…§å®¹</th>
                            <th style="width: 20%;">é è¦½</th>
                            <th style="width: 10%;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="poolItemsBody"></tbody>
                </table>
                <button class="btn btn-sm btn-success" style="margin-top: 10px;" onclick="addPoolItem()">
                    â• æ–°å¢é¸é …
                </button>
            </div>

            <div class="modal-footer">
                <button class="btn btn-primary" onclick="savePool()">å„²å­˜</button>
                <button class="btn" onclick="closeModal('poolModal')">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- é¡Œç›®é›†ç·¨è¼¯ Modal -->
    <div class="modal" id="setModal">
        <div class="modal-content">
            <div class="modal-header">
                <span id="setModalTitle">ç·¨è¼¯é¡Œç›®é›†</span>
                <span class="modal-close" onclick="closeModal('setModal')">Ã—</span>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">é¡Œç›®é›† ID <span class="required">*</span></label>
                    <input type="text" id="setId" class="form-input" placeholder="ä¾‹å¦‚: level1">
                </div>
                <div class="form-group">
                    <label class="form-label">åç¨±</label>
                    <input type="text" id="setName" class="form-input" placeholder="ä¾‹å¦‚: ç¬¬ä¸€é—œ">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">é è¨­é¸é …æ± </label>
                <div class="checkbox-group" id="setPoolCheckboxes">
                    <span style="color: #999;">è«‹å…ˆå‰µå»ºé¸é …æ± </span>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">é¡Œç›®åˆ—è¡¨</label>
                <table id="setQuestionsTable">
                    <thead>
                        <tr>
                            <th style="width: 15%;">é¡Œç›® ID</th>
                            <th style="width: 15%;">é¡Œå‹</th>
                            <th style="width: 30%;">å…§å®¹</th>
                            <th style="width: 15%;">ç­”æ¡ˆ ID</th>
                            <th style="width: 15%;">é¸é …æ± </th>
                            <th style="width: 10%;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="setQuestionsBody"></tbody>
                </table>
                <button class="btn btn-sm btn-success" style="margin-top: 10px;" onclick="addQuestion()">
                    â• æ–°å¢é¡Œç›®
                </button>
            </div>

            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveSet()">å„²å­˜</button>
                <button class="btn" onclick="closeModal('setModal')">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- AI åˆä½µ Modal -->
    <div class="modal" id="mergeAIModal">
        <div class="modal-content">
            <div class="modal-header">
                ğŸ¤– åˆä½µ AI ç”Ÿæˆçš„é¡Œç›®
                <span class="modal-close" onclick="closeModal('mergeAIModal')">Ã—</span>
            </div>

            <div class="alert alert-info">
                <strong>ğŸ’¡ ä½¿ç”¨èªªæ˜</strong><br>
                1. å°‡ AI ç”Ÿæˆçš„å®Œæ•´ JSON è²¼åˆ°ä¸‹æ–¹<br>
                2. ç³»çµ±æœƒè‡ªå‹•æ¸…ç†æ ¼å¼éŒ¯èª¤<br>
                3. åˆ†æé‡è¤‡ç‡ä¸¦é¡¯ç¤ºå»ºè­°<br>
                4. é¸æ“‡åˆä½µæ–¹å¼
            </div>

            <div class="form-group">
                <label class="form-label">AI ç”Ÿæˆçš„ JSON</label>
                <textarea id="mergeAIInput" class="form-textarea" rows="15" placeholder="è²¼ä¸Š AI ç”Ÿæˆçš„ JSON..."></textarea>
            </div>

            <div id="mergeAnalysis" class="hidden">
                <h4 style="margin: 15px 0;">ğŸ“Š åˆ†æçµæœ</h4>
                <div id="mergeStats"></div>
                
                <div class="form-group" style="margin-top: 15px;">
                    <label class="form-label">è™•ç†æ–¹å¼</label>
                    <select id="mergeMethod" class="form-select">
                        <option value="new-only">åªåŒ¯å…¥æ–°å…§å®¹ï¼ˆæ¨è–¦ï¼‰</option>
                        <option value="overwrite">å…¨éƒ¨è¦†è“‹ï¼ˆèˆŠçš„æœƒè¢«å–ä»£ï¼‰</option>
                        <option value="ask">é€ä¸€è©¢å•</option>
                    </select>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-primary" onclick="analyzeAIJSON()">
                    ğŸ” åˆ†æ JSON
                </button>
                <button class="btn btn-success" onclick="executeMerge()" id="executeMergeBtn" disabled>
                    âœ… åŸ·è¡Œåˆä½µ
                </button>
                <button class="btn" onclick="closeModal('mergeAIModal')">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        // ========== å…§å»ºç°¡å–®é©—è­‰å™¨ ==========
        function validatePool(pool) {
            const errors = [];
            
            if (!pool.type || !['text', 'image'].includes(pool.type)) {
                errors.push('é¡å‹å¿…é ˆæ˜¯ text æˆ– image');
            }
            
            if (!pool.items || pool.items.length < 2) {
                errors.push('è‡³å°‘éœ€è¦ 2 å€‹é¸é …ï¼ˆå»ºè­° 4 å€‹ä»¥ä¸Šï¼‰');
            }
            
            if (pool.items) {
                // æª¢æŸ¥ ID é‡è¤‡
                const ids = pool.items.map(i => i.id);
                const duplicates = ids.filter((id, index) => ids.indexOf(id) !== index);
                if (duplicates.length > 0) {
                    errors.push('é¸é … ID é‡è¤‡ï¼š' + [...new Set(duplicates)].join(', '));
                }
                
                // æª¢æŸ¥ç©ºç™½å…§å®¹
                const emptyItems = pool.items.filter(i => !i.id || !i.content);
                if (emptyItems.length > 0) {
                    errors.push(`æœ‰ ${emptyItems.length} å€‹é¸é …ç¼ºå°‘ ID æˆ–å…§å®¹`);
                }
            }
            
            return errors;
        }

        function validateQuestionSet(set, allPools) {
            const errors = [];
            
            if (!set.questions || set.questions.length === 0) {
                errors.push('è‡³å°‘éœ€è¦ 1 å€‹é¡Œç›®');
            }
            
            if (set.questions) {
                set.questions.forEach((q, idx) => {
                    if (!q.id) {
                        errors.push(`é¡Œç›® #${idx + 1} ç¼ºå°‘ ID`);
                    }
                    
                    if (!q.content) {
                        errors.push(`é¡Œç›® ${q.id || '#' + (idx + 1)} ç¼ºå°‘å…§å®¹`);
                    }
                    
                    if (!q.correctAnswer) {
                        errors.push(`é¡Œç›® ${q.id || '#' + (idx + 1)} ç¼ºå°‘æ­£ç¢ºç­”æ¡ˆ`);
                    }
                    
                    // æª¢æŸ¥ç­”æ¡ˆæ˜¯å¦å­˜åœ¨æ–¼é¸é …æ± ï¼ˆç°¡åŒ–ç‰ˆï¼‰
                    const poolIds = q.answerPoolIds || set.answerPoolIds || [];
                    if (poolIds.length > 0 && q.correctAnswer) {
                        let answerFound = false;
                        for (const poolId of poolIds) {
                            const pool = allPools[poolId];
                            if (pool && pool.items) {
                                if (pool.items.find(item => item.id === q.correctAnswer)) {
                                    answerFound = true;
                                    break;
                                }
                            }
                        }
                        if (!answerFound) {
                            errors.push(`é¡Œç›® ${q.id}: ç­”æ¡ˆã€Œ${q.correctAnswer}ã€ä¸åœ¨é¸é …æ± ä¸­`);
                        }
                    }
                });
                
                // æª¢æŸ¥é¡Œç›® ID é‡è¤‡
                const qIds = set.questions.map(q => q.id).filter(id => id);
                const duplicates = qIds.filter((id, index) => qIds.indexOf(id) !== index);
                if (duplicates.length > 0) {
                    errors.push('é¡Œç›® ID é‡è¤‡ï¼š' + [...new Set(duplicates)].join(', '));
                }
            }
            
            return errors;
        }

        // ========== ä¸»ç¨‹å¼ ==========
        let data = {
            answerPools: {},
            questionSets: {}
        };

        let currentEditPool = null;
        let currentEditSet = null;
        let imageDataMap = new Map(); // å­˜å„²åœ–ç‰‡çš„ base64 æ•¸æ“š

        // åˆå§‹åŒ–
        document.getElementById('loadFile').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    data = JSON.parse(e.target.result);
                    render();
                    alert('âœ… è¼‰å…¥æˆåŠŸï¼');
                } catch (err) {
                    alert('âŒ è¼‰å…¥å¤±æ•—: ' + err.message);
                }
            };
            reader.readAsText(file);
        });

        function render() {
            renderPools();
            renderSets();
            updateStats();
        }

        function updateStats() {
            const poolCount = Object.keys(data.answerPools).length;
            const setCount = Object.keys(data.questionSets).length;
            let questionCount = 0;
            
            for (const set of Object.values(data.questionSets)) {
                if (set.questions) questionCount += set.questions.length;
            }

            document.getElementById('statPools').textContent = poolCount;
            document.getElementById('statSets').textContent = setCount;
            document.getElementById('statQuestions').textContent = questionCount;
            
            if (poolCount > 0 || setCount > 0) {
                document.getElementById('stats').classList.remove('hidden');
            }
        }

        function renderPools() {
            const container = document.getElementById('poolsList');
            
            if (Object.keys(data.answerPools).length === 0) {
                container.innerHTML = '<div class="empty-state">å°šç„¡é¸é …æ± ï¼Œé»æ“Šã€Œæ–°å¢é¸é …æ± ã€é–‹å§‹</div>';
                return;
            }

            container.innerHTML = '';
            for (const [id, pool] of Object.entries(data.answerPools)) {
                const itemCount = pool.items?.length || 0;
                const status = itemCount < 4 ? 'warning' : 'ok';
                const statusText = itemCount < 4 ? 'âš ï¸ é¸é …ä¸è¶³' : 'âœ… ç„¡å•é¡Œ';

                const item = document.createElement('div');
                item.className = 'collapsible-item pool';
                item.innerHTML = `
                    <div class="item-header" onclick="toggleItem(this)">
                        <div class="item-header-left">
                            <div class="expand-icon">â–¶</div>
                            <div>
                                <div class="item-title">
                                    <code>${id}</code> - ${pool.name || '(ç„¡åç¨±)'}
                                    ${pool.category ? `<span class="badge badge-category">${pool.category}</span>` : ''}
                                </div>
                                <div class="item-meta">
                                    é¡å‹: ${pool.type} | ${itemCount} å€‹é¸é …
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;" onclick="event.stopPropagation()">
                            <span class="item-status status-${status}">${statusText}</span>
                            <div class="item-actions">
                                <button class="btn btn-sm btn-primary" onclick="editPool('${id}')">ç·¨è¼¯</button>
                                <button class="btn btn-sm btn-danger" onclick="deletePool('${id}')">åˆªé™¤</button>
                            </div>
                        </div>
                    </div>
                    <div class="item-content">
                        ${renderPoolTable(pool)}
                    </div>
                `;
                container.appendChild(item);
            }
        }

        function renderPoolTable(pool) {
            if (!pool.items || pool.items.length === 0) {
                return '<p style="color: #999;">ç„¡é¸é …</p>';
            }

            let html = '<table><thead><tr><th>ID</th><th>å…§å®¹</th><th>é è¦½</th><th>ç‹€æ…‹</th></tr></thead><tbody>';
            
            for (const item of pool.items) {
                const preview = pool.type === 'image' ? 
                    `<img src="${item.content}" class="preview-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                     <span class="path-error" style="display:none;">âŒ åœ–ç‰‡è¼‰å…¥å¤±æ•—</span>` :
                    '-';
                
                html += `
                    <tr>
                        <td><code>${item.id}</code></td>
                        <td>${truncate(item.content, 50)}</td>
                        <td>${preview}</td>
                        <td><span class="status-ok">âœ…</span></td>
                    </tr>
                `;
            }
            
            html += '</tbody></table>';
            return html;
        }

        function renderSets() {
            const container = document.getElementById('setsList');
            
            if (Object.keys(data.questionSets).length === 0) {
                container.innerHTML = '<div class="empty-state">å°šç„¡é¡Œç›®é›†ï¼Œé»æ“Šã€Œæ–°å¢é¡Œç›®é›†ã€é–‹å§‹</div>';
                return;
            }

            container.innerHTML = '';
            for (const [id, set] of Object.entries(data.questionSets)) {
                const questionCount = set.questions?.length || 0;
                const poolIds = set.answerPoolIds?.join(', ') || '(ç„¡)';

                const item = document.createElement('div');
                item.className = 'collapsible-item set';
                item.innerHTML = `
                    <div class="item-header" onclick="toggleItem(this)">
                        <div class="item-header-left">
                            <div class="expand-icon">â–¶</div>
                            <div>
                                <div class="item-title">
                                    <code>${id}</code> - ${set.name || '(ç„¡åç¨±)'}
                                </div>
                                <div class="item-meta">
                                    ${questionCount} é¡Œ | é¸é …æ± : ${poolIds}
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;" onclick="event.stopPropagation()">
                            <span class="item-status status-ok">âœ… ç„¡å•é¡Œ</span>
                            <div class="item-actions">
                                <button class="btn btn-sm btn-primary" onclick="editSet('${id}')">ç·¨è¼¯</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteSet('${id}')">åˆªé™¤</button>
                            </div>
                        </div>
                    </div>
                    <div class="item-content">
                        ${renderSetTable(set)}
                    </div>
                `;
                container.appendChild(item);
            }
        }

        function renderSetTable(set) {
            if (!set.questions || set.questions.length === 0) {
                return '<p style="color: #999;">ç„¡é¡Œç›®</p>';
            }

            let html = '<table><thead><tr><th>ID</th><th>é¡Œå‹</th><th>å…§å®¹</th><th>ç­”æ¡ˆ</th><th>é¸é …æ± </th><th>ç‹€æ…‹</th></tr></thead><tbody>';
            
            for (const q of set.questions) {
                const poolIds = q.answerPoolIds?.map(p => `<span class="badge badge-pool">${p}</span>`).join(' ') || '-';
                
                html += `
                    <tr>
                        <td><code>${q.id}</code></td>
                        <td>${q.type === 'image' ? 'åœ–ç‰‡' : 'æ–‡å­—'}</td>
                        <td>${truncate(q.content, 30)}</td>
                        <td><code>${q.correctAnswer}</code></td>
                        <td>${poolIds}</td>
                        <td><span class="status-ok">âœ…</span></td>
                    </tr>
                `;
            }
            
            html += '</tbody></table>';
            return html;
        }

        function toggleItem(header) {
            const item = header.closest('.collapsible-item');
            item.classList.toggle('expanded');
        }

        function truncate(str, length) {
            if (!str) return '-';
            if (str.length <= length) return str;
            return str.substring(0, length) + '...';
        }

        // Modal æ§åˆ¶
        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // é¸é …æ± æ“ä½œ
        function openNewPool() {
            currentEditPool = null;
            document.getElementById('poolModalTitle').textContent = 'æ–°å¢é¸é …æ± ';
            document.getElementById('poolId').value = '';
            document.getElementById('poolName').value = '';
            document.getElementById('poolType').value = 'text';
            document.getElementById('poolCategory').value = '';
            document.getElementById('poolItemsBody').innerHTML = '';
            addPoolItem();
            addPoolItem();
            openModal('poolModal');
        }

        function addPoolItem() {
            const tbody = document.getElementById('poolItemsBody');
            const row = tbody.insertRow();
            row.innerHTML = `
                <td><input type="text" class="form-input" placeholder="ID" data-field="id"></td>
                <td><input type="text" class="form-input" placeholder="å…§å®¹æˆ–è·¯å¾‘" data-field="content"></td>
                <td>-</td>
                <td><button class="btn btn-sm btn-danger" onclick="this.closest('tr').remove()">åˆªé™¤</button></td>
            `;
        }

        function savePool() {
            const id = document.getElementById('poolId').value.trim();
            if (!id) {
                alert('è«‹è¼¸å…¥æ±  ID');
                return;
            }

            const items = [];
            document.querySelectorAll('#poolItemsBody tr').forEach(row => {
                const itemId = row.querySelector('[data-field="id"]').value.trim();
                const content = row.querySelector('[data-field="content"]').value.trim();
                if (itemId && content) {
                    items.push({ id: itemId, content: content });
                }
            });

            const pool = {
                name: document.getElementById('poolName').value.trim(),
                type: document.getElementById('poolType').value,
                category: document.getElementById('poolCategory').value.trim() || undefined,
                items: items
            };

            // ä½¿ç”¨å…§å»ºé©—è­‰å™¨
            const errors = validatePool(pool);
            if (errors.length > 0) {
                alert('âŒ ç™¼ç¾å•é¡Œï¼š\n\n' + errors.map((e, i) => `${i + 1}. ${e}`).join('\n') + 
                      '\n\nğŸ’¡ æç¤ºï¼šå„²å­˜å¾Œå¯ç”¨ã€Œteacher-review-v2.htmlã€åšå®Œæ•´é©—è­‰');
                return;
            }

            if (currentEditPool && currentEditPool !== id) {
                delete data.answerPools[currentEditPool];
            }

            data.answerPools[id] = pool;

            closeModal('poolModal');
            render();
        }

        function editPool(id) {
            currentEditPool = id;
            const pool = data.answerPools[id];
            
            document.getElementById('poolModalTitle').textContent = 'ç·¨è¼¯é¸é …æ± ';
            document.getElementById('poolId').value = id;
            document.getElementById('poolName').value = pool.name || '';
            document.getElementById('poolType').value = pool.type;
            document.getElementById('poolCategory').value = pool.category || '';
            
            const tbody = document.getElementById('poolItemsBody');
            tbody.innerHTML = '';
            
            if (pool.items) {
                pool.items.forEach(item => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td><input type="text" class="form-input" data-field="id" value="${item.id}"></td>
                        <td><input type="text" class="form-input" data-field="content" value="${item.content}"></td>
                        <td>${pool.type === 'image' ? '<img src="'+item.content+'" class="preview-img" onerror="this.src=\'\'">' : '-'}</td>
                        <td><button class="btn btn-sm btn-danger" onclick="this.closest('tr').remove()">åˆªé™¤</button></td>
                    `;
                });
            }
            
            openModal('poolModal');
        }

        function deletePool(id) {
            if (confirm(`ç¢ºå®šè¦åˆªé™¤é¸é …æ± ã€Œ${id}ã€å—ï¼Ÿ`)) {
                delete data.answerPools[id];
                render();
            }
        }

        // é¡Œç›®é›†æ“ä½œ
        function openNewSet() {
            currentEditSet = null;
            document.getElementById('setModalTitle').textContent = 'æ–°å¢é¡Œç›®é›†';
            document.getElementById('setId').value = '';
            document.getElementById('setName').value = '';
            updatePoolCheckboxes();
            document.getElementById('setQuestionsBody').innerHTML = '';
            addQuestion();
            openModal('setModal');
        }

        function updatePoolCheckboxes(selectedPools = []) {
            const container = document.getElementById('setPoolCheckboxes');
            const pools = Object.keys(data.answerPools);
            
            if (pools.length === 0) {
                container.innerHTML = '<span style="color: #999;">è«‹å…ˆå‰µå»ºé¸é …æ± </span>';
                return;
            }

            container.innerHTML = '';
            pools.forEach(poolId => {
                const label = document.createElement('label');
                label.className = 'checkbox-label';
                label.innerHTML = `
                    <input type="checkbox" value="${poolId}" ${selectedPools.includes(poolId) ? 'checked' : ''}>
                    <span>${poolId}</span>
                `;
                container.appendChild(label);
            });
        }

        function addQuestion() {
            const tbody = document.getElementById('setQuestionsBody');
            const row = tbody.insertRow();
            
            // å»ºç«‹é¸é …æ± ä¸‹æ‹‰é¸å–®
            const poolOptions = Object.keys(data.answerPools).map(p => 
                `<option value="${p}">${p}</option>`
            ).join('');

            row.innerHTML = `
                <td><input type="text" class="form-input" placeholder="ID" data-field="id"></td>
                <td>
                    <select class="form-select" data-field="questionType">
                        <option value="single">å–®é¸é¡Œ</option>
                        <option value="multiple" disabled style="color: #999;">è¤‡é¸é¡Œï¼ˆæœªä¾†æ”¯æ´ï¼‰</option>
                    </select>
                </td>
                <td><textarea class="form-textarea" placeholder="å…§å®¹" data-field="content" rows="2"></textarea></td>
                <td><input type="text" class="form-input" placeholder="ç­”æ¡ˆID" data-field="correctAnswer"></td>
                <td>
                    <select class="form-select" data-field="pools" multiple size="3">
                        ${poolOptions || '<option disabled>ç„¡é¸é …æ± </option>'}
                    </select>
                </td>
                <td><button class="btn btn-sm btn-danger" onclick="this.closest('tr').remove()">åˆªé™¤</button></td>
            `;
        }

        function saveSet() {
            const id = document.getElementById('setId').value.trim();
            if (!id) {
                alert('è«‹è¼¸å…¥é¡Œç›®é›† ID');
                return;
            }

            // ç²å–é¸ä¸­çš„é¸é …æ± 
            const selectedPools = Array.from(document.querySelectorAll('#setPoolCheckboxes input:checked'))
                .map(cb => cb.value);

            const questions = [];
            document.querySelectorAll('#setQuestionsBody tr').forEach(row => {
                const qId = row.querySelector('[data-field="id"]').value.trim();
                const content = row.querySelector('[data-field="content"]').value.trim();
                const correctAnswer = row.querySelector('[data-field="correctAnswer"]').value.trim();
                const poolSelect = row.querySelector('[data-field="pools"]');
                const selectedQuestionPools = Array.from(poolSelect.selectedOptions).map(opt => opt.value);

                if (qId && content && correctAnswer) {
                    const question = {
                        id: qId,
                        type: 'text', // ç›®å‰åªæ”¯æ´æ–‡å­—
                        content: content,
                        correctAnswer: correctAnswer
                    };

                    if (selectedQuestionPools.length > 0) {
                        question.answerPoolIds = selectedQuestionPools;
                    }

                    questions.push(question);
                }
            });

            const set = {
                name: document.getElementById('setName').value.trim(),
                answerPoolIds: selectedPools,
                questions: questions
            };

            // ä½¿ç”¨å…§å»ºé©—è­‰å™¨
            const errors = validateQuestionSet(set, data.answerPools);
            if (errors.length > 0) {
                alert('âŒ ç™¼ç¾å•é¡Œï¼š\n\n' + errors.map((e, i) => `${i + 1}. ${e}`).join('\n') + 
                      '\n\nğŸ’¡ æç¤ºï¼šå„²å­˜å¾Œå¯ç”¨ã€Œteacher-review-v2.htmlã€åšå®Œæ•´é©—è­‰');
                return;
            }

            if (currentEditSet && currentEditSet !== id) {
                delete data.questionSets[currentEditSet];
            }

            data.questionSets[id] = set;

            closeModal('setModal');
            render();
        }

        function editSet(id) {
            currentEditSet = id;
            const set = data.questionSets[id];
            
            document.getElementById('setModalTitle').textContent = 'ç·¨è¼¯é¡Œç›®é›†';
            document.getElementById('setId').value = id;
            document.getElementById('setName').value = set.name || '';
            updatePoolCheckboxes(set.answerPoolIds || []);
            
            const tbody = document.getElementById('setQuestionsBody');
            tbody.innerHTML = '';
            
            if (set.questions) {
                set.questions.forEach(q => {
                    const poolOptions = Object.keys(data.answerPools).map(p => {
                        const selected = q.answerPoolIds?.includes(p) ? 'selected' : '';
                        return `<option value="${p}" ${selected}>${p}</option>`;
                    }).join('');

                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td><input type="text" class="form-input" data-field="id" value="${q.id}"></td>
                        <td>
                            <select class="form-select" data-field="questionType">
                                <option value="single">å–®é¸é¡Œ</option>
                                <option value="multiple" disabled style="color: #999;">è¤‡é¸é¡Œï¼ˆæœªä¾†æ”¯æ´ï¼‰</option>
                            </select>
                        </td>
                        <td><textarea class="form-textarea" data-field="content" rows="2">${q.content}</textarea></td>
                        <td><input type="text" class="form-input" data-field="correctAnswer" value="${q.correctAnswer}"></td>
                        <td>
                            <select class="form-select" data-field="pools" multiple size="3">
                                ${poolOptions}
                            </select>
                        </td>
                        <td><button class="btn btn-sm btn-danger" onclick="this.closest('tr').remove()">åˆªé™¤</button></td>
                    `;
                });
            }
            
            openModal('setModal');
        }

        function deleteSet(id) {
            if (confirm(`ç¢ºå®šè¦åˆªé™¤é¡Œç›®é›†ã€Œ${id}ã€å—ï¼Ÿ`)) {
                delete data.questionSets[id];
                render();
            }
        }

        // AI Prompt ç”Ÿæˆå™¨
        function openPromptGenerator() {
            updatePromptForm();
            openModal('promptModal');
        }

        function updatePromptForm() {
            const scenario = document.getElementById('promptScenario').value;
            const expandFields = document.getElementById('expandFields');
            
            if (scenario === 'new') {
                expandFields.classList.add('hidden');
            } else {
                expandFields.classList.remove('hidden');
            }

            document.getElementById('promptOutputArea').classList.add('hidden');
        }

        function generatePrompt() {
            const scenario = document.getElementById('promptScenario').value;
            const theme = document.getElementById('promptTheme').value.trim();
            const difficulty = document.getElementById('promptDifficulty').value;
            const questionCount = document.getElementById('promptQuestionCount').value;
            const optionCount = document.getElementById('promptOptionCount').value;

            if (!theme) {
                alert('è«‹è¼¸å…¥ä¸»é¡Œåç¨±');
                return;
            }

            let prompt = '';
            const exampleJSON = getExampleJSON();

            if (scenario === 'new') {
                prompt = `è«‹å¹«æˆ‘ç”Ÿæˆä¸€å€‹ã€Œ${theme}ã€çš„é¡Œåº«ï¼Œè¦æ±‚å¦‚ä¸‹ï¼š

ã€åŸºæœ¬è¨­å®šã€‘
- é›£åº¦ï¼š${difficulty === 'easy' ? 'ç°¡å–®' : difficulty === 'medium' ? 'ä¸­ç­‰' : 'å›°é›£'}
- é¡Œç›®æ•¸é‡ï¼š${questionCount} é¡Œ
- æ¯å€‹é¸é …æ± è‡³å°‘ ${optionCount} å€‹é¸é …

ã€æ ¼å¼è¦æ±‚ - éå¸¸é‡è¦ã€‘
è«‹åš´æ ¼æŒ‰ç…§ä»¥ä¸‹ JSON æ ¼å¼è¼¸å‡ºï¼š

${exampleJSON}

ã€JSON æ ¼å¼è¦å‰‡ - å¿…é ˆéµå®ˆã€‘
1. ä½¿ç”¨å†’è™Ÿ ":" ä¸æ˜¯ç­‰è™Ÿ "="
   âœ… æ­£ç¢º: "id": "A1"
   âŒ éŒ¯èª¤: "id" = "A1"
   
2. å­—ä¸²ç”¨é›™å¼•è™Ÿ " " ä¸æ˜¯å–®å¼•è™Ÿ ' '
   âœ… æ­£ç¢º: "content": "é¸é …1"
   âŒ éŒ¯èª¤: 'content': 'é¸é …1'

3. ä¸è¦æœ‰è¨»è§£æˆ–èªªæ˜æ–‡å­—
   âŒ éŒ¯èª¤: // é€™æ˜¯è¨»è§£
   âŒ éŒ¯èª¤: /* é€™æ˜¯é¸é …æ±  */

4. ä¸è¦ç”¨ Markdown ä»£ç¢¼å¡Š
   âŒ éŒ¯èª¤: \`\`\`json
   âŒ éŒ¯èª¤: \`\`\`

ã€å…§å®¹è¦æ±‚ã€‘
1. æ¯å€‹é¸é …æ± çš„ items è‡³å°‘è¦æœ‰ ${optionCount} å€‹é¸é …
2. æ‰€æœ‰é¡Œç›®çš„ correctAnswer å¿…é ˆå­˜åœ¨æ–¼å°æ‡‰çš„é¸é …æ± ä¸­
3. é¸é … ID è¦æ¸…æ¥šæ˜ç¢ºï¼Œé¿å…æ··æ·†
4. ç¢ºä¿ JSON æ ¼å¼å®Œå…¨æ­£ç¢º

ã€è¼¸å‡ºæ ¼å¼ã€‘
è«‹ç›´æ¥è¼¸å‡º JSONï¼Œä¸è¦æœ‰ä»»ä½•å…¶ä»–æ–‡å­—ã€‚`;

            } else if (scenario === 'expand-questions') {
                const existingSetId = document.getElementById('promptExistingSetId').value.trim();
                
                prompt = `æˆ‘æœ‰ä¸€å€‹ã€Œ${theme}ã€çš„é¡Œåº«ï¼Œç¾åœ¨è¦æ“´å……é¡Œç›®ã€‚

ã€ç¾æœ‰é¡Œç›®é›† IDã€‘
${existingSetId || '(è«‹å¡«å¯«)'}

ã€æ–°å¢è¦æ±‚ã€‘
- æ–°å¢ ${questionCount} é¡Œ
- é›£åº¦ï¼š${difficulty === 'easy' ? 'ç°¡å–®' : difficulty === 'medium' ? 'ä¸­ç­‰' : 'å›°é›£'}
- é¸é …æ± å¯ä»¥ä½¿ç”¨ç¾æœ‰çš„ï¼Œä¹Ÿå¯ä»¥æ–°å¢

ã€æ ¼å¼è¦æ±‚ã€‘
è«‹åªè¼¸å‡ºã€Œæ–°å¢ã€çš„éƒ¨åˆ†ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

${exampleJSON}

ã€JSON æ ¼å¼è¦å‰‡ - å¿…é ˆéµå®ˆã€‘
1. ä½¿ç”¨å†’è™Ÿ ":" ä¸æ˜¯ç­‰è™Ÿ "="
2. å­—ä¸²ç”¨é›™å¼•è™Ÿ " " ä¸æ˜¯å–®å¼•è™Ÿ ' '
3. ä¸è¦æœ‰è¨»è§£ã€Markdown æ¨™è¨˜ã€æˆ–ä»»ä½•èªªæ˜æ–‡å­—
4. ç›´æ¥è¼¸å‡ºç´” JSON

ã€æ³¨æ„äº‹é …ã€‘
1. åªè¼¸å‡ºæ–°å¢çš„é¸é …æ± ï¼ˆå¦‚æœæœ‰ï¼‰å’Œæ–°å¢çš„é¡Œç›®é›†
2. é¡Œç›®é›† ID è¦èˆ‡ç¾æœ‰çš„ä¸åŒï¼ˆä¾‹å¦‚ï¼š${existingSetId || 'level1'} â†’ ${existingSetId || 'level1'}_newï¼‰
3. ç¢ºä¿ JSON æ ¼å¼æ­£ç¢º`;

            } else if (scenario === 'expand-pools') {
                const existingPoolId = document.getElementById('promptExistingPoolId').value.trim();
                
                prompt = `æˆ‘æœ‰ä¸€å€‹ã€Œ${theme}ã€çš„é¡Œåº«ï¼Œç¾åœ¨è¦æ“´å……é¸é …æ± ã€‚

ã€ç¾æœ‰é¸é …æ±  IDã€‘
${existingPoolId || '(è«‹å¡«å¯«)'}

ã€æ–°å¢è¦æ±‚ã€‘
- æ–°å¢ ${optionCount} å€‹é¸é …

ã€æ ¼å¼è¦æ±‚ã€‘
è«‹åªè¼¸å‡ºé¸é …æ± éƒ¨åˆ†ï¼Œä½¿ç”¨å†’è™Ÿ ":" ä¸æ˜¯ç­‰è™Ÿ "="ï¼š

{
  "answerPools": {
    "${existingPoolId || 'pool_id'}_new": {
      "name": "é¸é …æ± åç¨±",
      "type": "text",
      "items": [
        { "id": "NEW_1", "content": "æ–°é¸é … 1" },
        { "id": "NEW_2", "content": "æ–°é¸é … 2" }
      ]
    }
  }
}

ã€æ³¨æ„äº‹é …ã€‘
1. æ–°é¸é …çš„ ID è¦èˆ‡ç¾æœ‰çš„ä¸åŒ
2. ä½¿ç”¨å†’è™Ÿ ":" ä¸æ˜¯ç­‰è™Ÿ "="
3. ä¸è¦æœ‰ Markdown æ¨™è¨˜æˆ–è¨»è§£
4. ç¢ºä¿ JSON æ ¼å¼æ­£ç¢º`;
            }

            document.getElementById('promptOutput').textContent = prompt;
            document.getElementById('promptOutputArea').classList.remove('hidden');
        }

        function getExampleJSON() {
            return `{
  "answerPools": {
    "pool_1": {
      "name": "é¸é …æ± åç¨±",
      "type": "text",
      "category": "é¡åˆ¥ï¼ˆé¸ç”¨ï¼‰",
      "items": [
        { "id": "A1", "content": "é¸é … 1" },
        { "id": "A2", "content": "é¸é … 2" },
        { "id": "A3", "content": "é¸é … 3" },
        { "id": "A4", "content": "é¸é … 4" }
      ]
    }
  },
  "questionSets": {
    "set_1": {
      "name": "é¡Œç›®é›†åç¨±",
      "answerPoolIds": ["pool_1"],
      "questions": [
        {
          "id": "q1",
          "type": "text",
          "content": "é¡Œç›®å…§å®¹",
          "correctAnswer": "A1"
        }
      ]
    }
  }
}`;
        }

        function copyPrompt() {
            const promptText = document.getElementById('promptOutput').textContent;
            navigator.clipboard.writeText(promptText).then(() => {
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = 'âœ… å·²è¤‡è£½';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                }, 2000);
            });
        }

        // æ‰¹é‡åŒ¯å…¥åœ–ç‰‡
        function openBatchImageUpload() {
            document.getElementById('imagePreviewArea').classList.add('hidden');
            document.getElementById('importPoolBtn').disabled = true;
            document.getElementById('importQuestionsBtn').disabled = true;
            openModal('imageUploadModal');
        }

        function previewImages() {
            const files = document.getElementById('batchImageInput').files;
            if (files.length === 0) return;

            const grid = document.getElementById('imagePreviewGrid');
            grid.innerHTML = '';
            imageDataMap.clear();

            const method = document.getElementById('imageIdMethod').value;

            Array.from(files).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imgData = e.target.result;
                    imageDataMap.set(file.name, imgData);

                    const item = document.createElement('div');
                    item.className = 'image-preview-item';
                    
                    const id = method === 'filename' ? 
                        file.name.replace(/\.[^/.]+$/, '') : 
                        `IMG_${String(index + 1).padStart(3, '0')}`;

                    item.innerHTML = `
                        <img src="${imgData}" alt="${file.name}">
                        <div style="font-size: 0.85rem; color: #7f8c8d; margin-bottom: 5px;">${file.name}</div>
                        <input type="text" value="${id}" placeholder="è¼¸å…¥ ID" data-filename="${file.name}">
                    `;
                    grid.appendChild(item);
                };
                reader.readAsDataURL(file);
            });

            document.getElementById('imagePreviewArea').classList.remove('hidden');
            document.getElementById('importPoolBtn').disabled = false;
            document.getElementById('importQuestionsBtn').disabled = false;
        }

        function updateImageIds() {
            const files = document.getElementById('batchImageInput').files;
            if (files.length === 0) return;

            const method = document.getElementById('imageIdMethod').value;
            const inputs = document.querySelectorAll('#imagePreviewGrid input');

            inputs.forEach((input, index) => {
                const filename = input.dataset.filename;
                const id = method === 'filename' ? 
                    filename.replace(/\.[^/.]+$/, '') : 
                    `IMG_${String(index + 1).padStart(3, '0')}`;
                input.value = id;
            });
        }

        function importAsPool() {
            const poolId = prompt('è«‹è¼¸å…¥é¸é …æ±  ID:', 'images_' + Date.now());
            if (!poolId) return;

            const items = [];
            document.querySelectorAll('#imagePreviewGrid .image-preview-item').forEach(item => {
                const input = item.querySelector('input');
                const id = input.value.trim();
                const filename = input.dataset.filename;
                
                if (id) {
                    items.push({
                        id: id,
                        content: `img/${filename}` // å‡è¨­åœ–ç‰‡æ”¾åœ¨ img/ ç›®éŒ„
                    });
                }
            });

            if (items.length === 0) {
                alert('æ²’æœ‰æœ‰æ•ˆçš„åœ–ç‰‡');
                return;
            }

            data.answerPools[poolId] = {
                name: poolId,
                type: 'image',
                items: items
            };

            closeModal('imageUploadModal');
            render();
            alert(`âœ… å·²åŒ¯å…¥ ${items.length} å¼µåœ–ç‰‡åˆ°é¸é …æ± ã€Œ${poolId}ã€`);
        }

        function importAsQuestions() {
            alert('æ­¤åŠŸèƒ½é–‹ç™¼ä¸­ï¼Œè«‹å…ˆåŒ¯å…¥ç‚ºé¸é …æ± å¾Œï¼Œå†æ‰‹å‹•å»ºç«‹é¡Œç›®ã€‚');
        }

        // å…¶ä»–åŠŸèƒ½
        function downloadSampleJSON() {
            const sample = {
                answerPools: {
                    example_pool: {
                        name: "ç¯„ä¾‹é¸é …æ± ",
                        type: "text",
                        category: "ç¯„ä¾‹é¡åˆ¥",
                        items: [
                            { id: "A1", content: "é¸é … 1" },
                            { id: "A2", content: "é¸é … 2" },
                            { id: "A3", content: "é¸é … 3" },
                            { id: "A4", content: "é¸é … 4" }
                        ]
                    }
                },
                questionSets: {
                    example_set: {
                        name: "ç¯„ä¾‹é¡Œç›®é›†",
                        answerPoolIds: ["example_pool"],
                        questions: [
                            {
                                id: "q1",
                                type: "text",
                                content: "é€™æ˜¯ç¯„ä¾‹é¡Œç›®ï¼Ÿ",
                                correctAnswer: "A1"
                            }
                        ]
                    }
                }
            };

            const dataStr = JSON.stringify(sample, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'sample_questions.json';
            link.click();
            URL.revokeObjectURL(url);
        }

        function exportJSON() {
            if (Object.keys(data.answerPools).length === 0 && Object.keys(data.questionSets).length === 0) {
                alert('æ²’æœ‰å¯åŒ¯å‡ºçš„è³‡æ–™');
                return;
            }

            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'questions.json';
            link.click();
            URL.revokeObjectURL(url);
        }

        function clearAll() {
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
                data = {
                    answerPools: {},
                    questionSets: {}
                };
                render();
            }
        }

        // åˆå§‹åŒ–
        render();

        // AI åˆä½µåŠŸèƒ½
        let mergeData = null;
        let mergeAnalysisResult = null;

        function openMergeAI() {
            document.getElementById('mergeAIInput').value = '';
            document.getElementById('mergeAnalysis').classList.add('hidden');
            document.getElementById('executeMergeBtn').disabled = true;
            openModal('mergeAIModal');
        }

        function cleanAIJSON(rawText) {
            let cleaned = rawText;
            
            // ç§»é™¤ Markdown ä»£ç¢¼å¡Š
            cleaned = cleaned.replace(/```json\s*/g, '');
            cleaned = cleaned.replace(/```\s*/g, '');
            
            // ç§»é™¤å‰å¾Œçš„èªªæ˜æ–‡å­—ï¼Œåªä¿ç•™ JSON
            const jsonStart = cleaned.indexOf('{');
            const jsonEnd = cleaned.lastIndexOf('}');
            if (jsonStart !== -1 && jsonEnd !== -1) {
                cleaned = cleaned.substring(jsonStart, jsonEnd + 1);
            }
            
            // ä¿®æ­£å¸¸è¦‹çš„ AI éŒ¯èª¤ï¼šä½¿ç”¨ = è€Œé :
            // é€™æ˜¯æœ€é—œéµçš„ä¿®æ­£
            cleaned = cleaned.replace(/"([^"]+)"\s*=\s*/g, '"$1": ');
            
            // ä¿®æ­£å–®å¼•è™Ÿç‚ºé›™å¼•è™Ÿ
            cleaned = cleaned.replace(/'([^']*)'/g, '"$1"');
            
            // ç§»é™¤è¨»è§£
            cleaned = cleaned.replace(/\/\*[\s\S]*?\*\//g, '');
            cleaned = cleaned.replace(/\/\/.*/g, '');
            
            // ç§»é™¤å¤šé¤˜çš„é€—è™Ÿ
            cleaned = cleaned.replace(/,(\s*[}\]])/g, '$1');
            
            return cleaned;
        }

        function analyzeAIJSON() {
            const rawInput = document.getElementById('mergeAIInput').value.trim();
            
            if (!rawInput) {
                alert('è«‹è²¼ä¸Š AI ç”Ÿæˆçš„ JSON');
                return;
            }

            try {
                // å¼·åŠ›æ¸…ç†
                const cleaned = cleanAIJSON(rawInput);
                
                // è§£æ
                mergeData = JSON.parse(cleaned);
                
                // åˆ†æé‡è¤‡ç‡
                const analysis = {
                    pools: { new: 0, duplicate: 0 },
                    sets: { new: 0, duplicate: 0 },
                    questions: { new: 0, duplicate: 0 }
                };

                // åˆ†æé¸é …æ± 
                if (mergeData.answerPools) {
                    for (const poolId in mergeData.answerPools) {
                        if (data.answerPools[poolId]) {
                            analysis.pools.duplicate++;
                        } else {
                            analysis.pools.new++;
                        }
                    }
                }

                // åˆ†æé¡Œç›®é›†
                if (mergeData.questionSets) {
                    for (const setId in mergeData.questionSets) {
                        if (data.questionSets[setId]) {
                            analysis.sets.duplicate++;
                        } else {
                            analysis.sets.new++;
                        }
                    }
                }

                mergeAnalysisResult = analysis;

                // é¡¯ç¤ºåˆ†æçµæœ
                displayMergeAnalysis(analysis);
                
                document.getElementById('executeMergeBtn').disabled = false;
                
            } catch (err) {
                alert('âŒ JSON è§£æå¤±æ•—:\n\n' + err.message + '\n\nè«‹æª¢æŸ¥ AI è¼¸å‡ºçš„æ ¼å¼æ˜¯å¦æ­£ç¢ºã€‚\n\nå¸¸è¦‹å•é¡Œï¼š\n- ä½¿ç”¨äº† = è€Œé :\n- ä½¿ç”¨äº†å–®å¼•è™Ÿè€Œéé›™å¼•è™Ÿ\n- æœ‰è¨»è§£æˆ– Markdown æ¨™è¨˜');
                console.error('åŸå§‹éŒ¯èª¤:', err);
                console.error('æ¸…ç†å¾Œçš„æ–‡å­—:', cleanAIJSON(rawInput));
            }
        }

        function displayMergeAnalysis(analysis) {
            const totalPools = analysis.pools.new + analysis.pools.duplicate;
            const totalSets = analysis.sets.new + analysis.sets.duplicate;
            const duplicateRate = totalPools > 0 ? 
                Math.round((analysis.pools.duplicate / totalPools) * 100) : 0;

            let html = '<div class="alert alert-success">';
            html += '<strong>âœ… JSON è§£ææˆåŠŸï¼</strong></div>';

            html += '<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin: 15px 0;">';
            
            html += `
                <div style="padding: 15px; background: #e8f4f8; border-radius: 8px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #0c5460;">${totalPools}</div>
                    <div style="color: #7f8c8d; font-size: 0.9rem;">é¸é …æ± ç¸½æ•¸</div>
                    <div style="color: #2ecc71; font-size: 0.85rem; margin-top: 5px;">æ–°å¢: ${analysis.pools.new}</div>
                    <div style="color: #f39c12; font-size: 0.85rem;">é‡è¤‡: ${analysis.pools.duplicate}</div>
                </div>
            `;

            html += `
                <div style="padding: 15px; background: #e8f4f8; border-radius: 8px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #0c5460;">${totalSets}</div>
                    <div style="color: #7f8c8d; font-size: 0.9rem;">é¡Œç›®é›†ç¸½æ•¸</div>
                    <div style="color: #2ecc71; font-size: 0.85rem; margin-top: 5px;">æ–°å¢: ${analysis.sets.new}</div>
                    <div style="color: #f39c12; font-size: 0.85rem;">é‡è¤‡: ${analysis.sets.duplicate}</div>
                </div>
            `;

            html += `
                <div style="padding: 15px; background: #e8f4f8; border-radius: 8px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #0c5460;">${duplicateRate}%</div>
                    <div style="color: #7f8c8d; font-size: 0.9rem;">é‡è¤‡ç‡</div>
                </div>
            `;

            html += '</div>';

            if (duplicateRate > 70) {
                html += '<div class="alert alert-warning">';
                html += '<strong>âš ï¸ é‡è¤‡ç‡éé«˜ï¼</strong><br>';
                html += 'å»ºè­°é¸æ“‡ã€ŒåªåŒ¯å…¥æ–°å…§å®¹ã€ï¼Œé¿å…è¦†è“‹ç¾æœ‰è³‡æ–™ã€‚';
                html += '</div>';
            }

            document.getElementById('mergeStats').innerHTML = html;
            document.getElementById('mergeAnalysis').classList.remove('hidden');
        }

        function executeMerge() {
            if (!mergeData) {
                alert('è«‹å…ˆåˆ†æ JSON');
                return;
            }

            const method = document.getElementById('mergeMethod').value;
            let mergedCount = { pools: 0, sets: 0 };
            let hasErrors = false;

            if (method === 'new-only') {
                // åªåŒ¯å…¥æ–°çš„
                if (mergeData.answerPools) {
                    for (const [id, pool] of Object.entries(mergeData.answerPools)) {
                        if (!data.answerPools[id]) {
                            const errors = validatePool(pool);
                            if (errors.length > 0) {
                                console.warn(`é¸é …æ±  ${id} æœ‰å•é¡Œ:`, errors);
                                hasErrors = true;
                            }
                            data.answerPools[id] = pool;
                            mergedCount.pools++;
                        }
                    }
                }

                if (mergeData.questionSets) {
                    for (const [id, set] of Object.entries(mergeData.questionSets)) {
                        if (!data.questionSets[id]) {
                            const errors = validateQuestionSet(set, data.answerPools);
                            if (errors.length > 0) {
                                console.warn(`é¡Œç›®é›† ${id} æœ‰å•é¡Œ:`, errors);
                                hasErrors = true;
                            }
                            data.questionSets[id] = set;
                            mergedCount.sets++;
                        }
                    }
                }

                closeModal('mergeAIModal');
                render();
                
                let message = `âœ… åˆä½µå®Œæˆï¼\n\næ–°å¢é¸é …æ± : ${mergedCount.pools}\næ–°å¢é¡Œç›®é›†: ${mergedCount.sets}`;
                if (hasErrors) {
                    message += '\n\nâš ï¸ éƒ¨åˆ†å…§å®¹æœ‰è­¦å‘Šï¼Œè«‹ç”¨ã€Œteacher-review-v2.htmlã€åšå®Œæ•´é©—è­‰';
                }
                alert(message);

            } else if (method === 'overwrite') {
                if (confirm('âš ï¸ ç¢ºå®šè¦å…¨éƒ¨è¦†è“‹å—ï¼Ÿ\n\né‡è¤‡çš„é¸é …æ± å’Œé¡Œç›®é›†æœƒè¢«æ–°çš„å–ä»£ã€‚')) {
                    if (mergeData.answerPools) {
                        for (const [id, pool] of Object.entries(mergeData.answerPools)) {
                            data.answerPools[id] = pool;
                            mergedCount.pools++;
                        }
                    }

                    if (mergeData.questionSets) {
                        for (const [id, set] of Object.entries(mergeData.questionSets)) {
                            data.questionSets[id] = set;
                            mergedCount.sets++;
                        }
                    }

                    closeModal('mergeAIModal');
                    render();
                    alert(`âœ… è¦†è“‹å®Œæˆï¼\n\nè™•ç†é¸é …æ± : ${mergedCount.pools}\nè™•ç†é¡Œç›®é›†: ${mergedCount.sets}\n\nğŸ’¡ å»ºè­°ç”¨ã€Œteacher-review-v2.htmlã€é©—è­‰`);
                }

            } else if (method === 'ask') {
                // é€ä¸€è©¢å•
                if (mergeData.answerPools) {
                    for (const [id, pool] of Object.entries(mergeData.answerPools)) {
                        if (data.answerPools[id]) {
                            if (confirm(`é¸é …æ± ã€Œ${id}ã€å·²å­˜åœ¨ï¼Œè¦è¦†è“‹å—ï¼Ÿ`)) {
                                data.answerPools[id] = pool;
                                mergedCount.pools++;
                            }
                        } else {
                            data.answerPools[id] = pool;
                            mergedCount.pools++;
                        }
                    }
                }

                if (mergeData.questionSets) {
                    for (const [id, set] of Object.entries(mergeData.questionSets)) {
                        if (data.questionSets[id]) {
                            if (confirm(`é¡Œç›®é›†ã€Œ${id}ã€å·²å­˜åœ¨ï¼Œè¦è¦†è“‹å—ï¼Ÿ`)) {
                                data.questionSets[id] = set;
                                mergedCount.sets++;
                            }
                        } else {
                            data.questionSets[id] = set;
                            mergedCount.sets++;
                        }
                    }
                }

                closeModal('mergeAIModal');
                render();
                alert(`âœ… åˆä½µå®Œæˆï¼\n\nè™•ç†é¸é …æ± : ${mergedCount.pools}\nè™•ç†é¡Œç›®é›†: ${mergedCount.sets}\n\nğŸ’¡ å»ºè­°ç”¨ã€Œteacher-review-v2.htmlã€é©—è­‰`);
            }
        }
    </script>
</body>
</html>
